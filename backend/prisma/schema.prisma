generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String         @id @default(uuid())
  email            String         @unique
  passwordHash     String
  firstName        String?
  lastName         String?
  role             UserRole       @default(USER)
  isEmailVerified  Boolean        @default(false)
  emailVerifiedAt  DateTime?
  twoFactorEnabled Boolean        @default(false)
  twoFactorSecret  String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  accounts         Account[]
  alerts           Alert[]
  assets           Asset[]
  auditLogs        AuditLog[]
  refreshTokens    RefreshToken[]
  sharedAccesses   SharedAccess[] @relation("SharedAccessOwner")
  receivedAccesses SharedAccess[] @relation("SharedAccessRecipient")
  subscription     Subscription?
  transactions     Transaction[]
  profile          UserProfile?

  @@index([email])
  @@map("users")
}

model UserProfile {
  id                 String    @id @default(uuid())
  userId             String    @unique
  phoneNumber        String?
  dateOfBirth        DateTime?
  address            String?
  city               String?
  postalCode         String?
  country            String?   @default("FR")
  currency           String    @default("EUR")
  timezone           String    @default("Europe/Paris")
  language           String    @default("fr")
  consentMarketing   Boolean   @default(false)
  consentAnalytics   Boolean   @default(false)
  consentDataSharing Boolean   @default(false)
  avatarUrl          String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Account {
  id                    String          @id @default(uuid())
  userId                String
  name                  String
  type                  AccountType
  provider              AccountProvider @default(MANUAL)
  externalId            String?
  externalAccountNumber String?
  balance               Float           @default(0)
  currency              String          @default("EUR")
  lastSyncedAt          DateTime?
  syncEnabled           Boolean         @default(true)
  metadata              Json?
  isActive              Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  assets                Asset[]
  transactions          Transaction[]

  @@index([userId])
  @@index([type])
  @@map("accounts")
}

model Asset {
  id               String            @id @default(uuid())
  userId           String
  accountId        String?
  name             String
  type             AssetType
  symbol           String?
  isin             String?
  quantity         Float             @default(1)
  purchasePrice    Float
  purchaseDate     DateTime?
  monthlyInvestment Float?
  currentPrice     Float
  currency         String            @default("EUR")
  totalValue       Float
  totalGain        Float             @default(0)
  totalGainPercent Float             @default(0)
  metadata         Json?
  lastPriceUpdate  DateTime?
  isActive         Boolean           @default(true)
  description      String?
  brand            String?
  model            String?
  year             Int?
  condition        String?
  serialNumber     String?
  certification    String?
  thumbnailUrl     String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  account          Account?          @relation(fields: [accountId], references: [id])
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  images           AssetImage[]
  priceHistory     PriceHistory[]
  predictions      AssetPrediction[]

  @@index([userId])
  @@index([accountId])
  @@index([type])
  @@index([symbol])
  @@index([brand])
  @@map("assets")
}

model AssetImage {
  id        String   @id @default(uuid())
  assetId   String
  url       String
  filename  String
  mimeType  String
  size      Int
  order     Int      @default(0)
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([isMain])
  @@map("asset_images")
}

model PriceHistory {
  id         String   @id @default(uuid())
  assetId    String
  price      Float
  source     String   @default("API")
  recordedAt DateTime @default(now())
  asset      Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, recordedAt])
  @@map("price_history")
}

model AssetPrediction {
  id             String   @id @default(uuid())
  assetId        String
  predictedPrice Float
  confidence     Float
  timeframe      String
  algorithm      String
  factors        Json?
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  asset          Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([expiresAt])
  @@map("asset_predictions")
}

model Transaction {
  id          String              @id @default(uuid())
  userId      String
  accountId   String?
  date        DateTime            @default(now())
  amount      Float
  type        TransactionType
  category    TransactionCategory @default(OTHER)
  description String?
  notes       String?
  externalId  String?
  metadata    Json?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  account     Account?            @relation(fields: [accountId], references: [id])
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([date])
  @@index([type])
  @@index([category])
  @@map("transactions")
}

model Alert {
  id              String      @id @default(uuid())
  userId          String
  name            String
  type            AlertType
  status          AlertStatus @default(ACTIVE)
  conditions      Json
  notifyEmail     Boolean     @default(true)
  notifyPush      Boolean     @default(false)
  lastTriggeredAt DateTime?
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("alerts")
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  plan                 SubscriptionPlan   @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([plan])
  @@index([status])
  @@map("subscriptions")
}

model SharedAccess {
  id               String           @id @default(uuid())
  ownerId          String
  sharedWithUserId String?
  sharedWithEmail  String
  permission       AccessPermission @default(VIEW)
  scope            Json?
  expiresAt        DateTime?
  isActive         Boolean          @default(true)
  acceptedAt       DateTime?
  revokedAt        DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  owner            User             @relation("SharedAccessOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  sharedWithUser   User?            @relation("SharedAccessRecipient", fields: [sharedWithUserId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([sharedWithUserId])
  @@index([sharedWithEmail])
  @@map("shared_accesses")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String?
  action     AuditAction
  entityType String?
  entityId   String?
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime    @default(now())
  user       User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  USER
  ADMIN
  ADVISOR
}

enum SubscriptionPlan {
  FREE
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  INCOMPLETE
}

enum AccountType {
  BANK
  CRYPTO
  SCPI
  INSURANCE
  REAL_ESTATE
  STOCK
  PEL
  SAVINGS
}

enum AccountProvider {
  MANUAL
  BUDGET_INSIGHT
  PLAID
  COINBASE
  BINANCE
  METAMASK
  OTHER
}

enum AssetType {
  STOCK
  ETF
  BOND
  CRYPTO
  SCPI
  REAL_ESTATE
  COMMODITY
  FUND
  CASH
  LUXURY_WATCH
  COLLECTOR_CAR
  ARTWORK
  WINE
  JEWELRY
  COLLECTIBLE
  OTHER
}

enum TransactionType {
  DEBIT
  CREDIT
}

enum TransactionCategory {
  SALARY
  INVESTMENT
  WITHDRAWAL
  DEPOSIT
  DIVIDEND
  INTEREST
  FEE
  TAX
  TRANSFER
  PURCHASE
  SALE
  RENT
  OTHER
}

enum AlertType {
  THRESHOLD
  DATE
  PERFORMANCE
  PRICE
  BALANCE
}

enum AlertStatus {
  ACTIVE
  TRIGGERED
  DISMISSED
}

enum AccessPermission {
  VIEW
  EDIT
  ADMIN
}

enum AuditAction {
  USER_LOGIN
  USER_LOGOUT
  USER_REGISTER
  USER_UPDATE
  USER_DELETE
  DATA_EXPORT
  DATA_DELETE
  CONSENT_UPDATE
  ACCOUNT_CREATE
  ACCOUNT_UPDATE
  ACCOUNT_DELETE
  ASSET_CREATE
  ASSET_UPDATE
  ASSET_DELETE
  TRANSACTION_CREATE
  ALERT_CREATE
  SUBSCRIPTION_UPDATE
  SHARED_ACCESS_CREATE
}
